// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Master Department Configuration
model MasterDepartment {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String   @unique
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("master_departments")
}

// Users & Authentication
model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole @default(SALESPERSON)
  name         String
  phone        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  initiatedCalls    Call[]                @relation("CallInitiator")
  callFeedbacks     CallFeedback[]
  crossSellAttempts CrossSellingAttempt[]
  remindersCreated  FollowUpReminder[]    @relation("ReminderCreator")
  remindersAssigned FollowUpReminder[]    @relation("ReminderAssignee")

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  SALESPERSON
}

// Customers
model Customer {
  id                   String    @id @default(auto()) @map("_id") @db.ObjectId
  customerId           String // Mobile1 from Excel
  normalizedCustomerId String    @map("normalized_customer_id")
  phone                String?
  visitCount           Int       @default(0) @map("visit_count")
  firstVisitDate       DateTime? @map("first_visit_date")
  lastVisitDate        DateTime? @map("last_visit_date")
  totalIncentiveAmount Float     @default(0) @map("total_incentive_amount")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  visits            CustomerVisit[]
  transactions      VisitTransaction[]
  calls             Call[]
  feedbacks         CallFeedback[]        @relation("CustomerCallFeedback")
  crossSellAttempts CrossSellingAttempt[]
  reminders         FollowUpReminder[]
  analytics         CustomerAnalytics?

  @@unique([normalizedCustomerId])
  @@map("customers")
}

// Customer Visits (Unique visit = CustomerID + Date + VoucherNo)
model CustomerVisit {
  id                        String   @id @default(auto()) @map("_id") @db.ObjectId
  customerId                String   @map("customer_id") @db.ObjectId
  visitDate                 DateTime @map("visit_date")
  voucherNo                 String?  @map("voucher_no")
  visitKey                  String   @unique @map("visit_key")
  departmentsVisited        String[] @map("departments_visited") // Array of departments
  departmentsNotVisited     String[] @map("departments_not_visited") // Array of NOT visited departments
  departmentsCount          Int      @map("departments_count")
  totalDepartmentsAvailable Int      @map("total_departments_available")
  incentiveAmount           Float    @default(0) @map("incentive_amount")
  salespersons              String[] // Array of salesperson names
  createdAt                 DateTime @default(now()) @map("created_at")

  customer          Customer              @relation(fields: [customerId], references: [id], onDelete: Cascade)
  transactions      VisitTransaction[]
  crossSellAttempts CrossSellingAttempt[]
  calls             Call[]
  callFeedbacks     CallFeedback[]

  @@index([customerId])
  @@index([visitDate])
  @@map("customer_visits")
}

// Visit Transactions (Individual orders/interactions)
model VisitTransaction {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  visitId         String   @map("visit_id") @db.ObjectId
  customerId      String   @map("customer_id") @db.ObjectId
  voucherNo       String   @map("voucher_no")
  voucherDate     DateTime @map("voucher_date")
  department      String
  counter         String?
  departmentLabel String   @map("department_label")
  salesperson     String
  createdAt       DateTime @default(now()) @map("created_at")

  visit    CustomerVisit @relation(fields: [visitId], references: [id], onDelete: Cascade)
  customer Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([visitId])
  @@index([customerId])
  @@map("visit_transactions")
}

// Calls
model Call {
  id             String             @id @default(auto()) @map("_id") @db.ObjectId
  customerId     String             @map("customer_id") @db.ObjectId
  visitId        String?            @map("visit_id") @db.ObjectId // Link to specific visit
  initiatedBy    String             @map("initiated_by") @db.ObjectId
  callType       CallType           @default(OUTBOUND) @map("call_type")
  providerCallId String?            @map("provider_call_id")
  provider       TelephonyProvider?
  status         CallStatus         @default(INITIATED)
  duration       Int? // Seconds
  startedAt      DateTime           @map("started_at")
  endedAt        DateTime?          @map("ended_at")
  recordingUrl   String?            @map("recording_url")
  bridgeStatus   BridgeStatus?      @map("bridge_status")
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  customer        Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  visit           CustomerVisit? @relation(fields: [visitId], references: [id], onDelete: Cascade)
  initiatedByUser User           @relation("CallInitiator", fields: [initiatedBy], references: [id])
  feedback        CallFeedback?
  auditLogs       CallAuditLog[]

  @@index([customerId])
  @@index([visitId])
  @@index([initiatedBy])
  @@index([status])
  @@map("calls")
}

enum CallType {
  INBOUND
  OUTBOUND
}

enum CallStatus {
  INITIATED
  RINGING
  ANSWERED
  COMPLETED
  FAILED
  NO_ANSWER
}

enum BridgeStatus {
  SALESPERSON_ANSWERED
  CUSTOMER_ANSWERED
  BOTH_ANSWERED
  FAILED
}

enum TelephonyProvider {
  EXOTEL
  KNOWLARITY
  TELECMI
}

// Call Feedback
model CallFeedback {
  id                             String       @id @default(auto()) @map("_id") @db.ObjectId
  callId                         String       @unique @map("call_id") @db.ObjectId
  customerId                     String       @map("customer_id") @db.ObjectId
  visitId                        String?      @map("visit_id") @db.ObjectId // Link to specific visit
  submittedBy                    String       @map("submitted_by") @db.ObjectId
  outcome                        CallOutcome
  customerMood                   CustomerMood
  rating                         Int? // 1-5
  notes                          String?
  requiresFollowUp               Boolean      @default(false) @map("requires_follow_up")
  followUpDate                   DateTime?    @map("follow_up_date")
  followUpReason                 String?      @map("follow_up_reason")
  nonVisitedDepartmentsDiscussed String[]     @map("non_visited_departments_discussed")
  nonVisitedReasons              Json?        @map("non_visited_reasons") // Array of NonVisitReason objects
  createdAt                      DateTime     @default(now()) @map("created_at")

  call            Call           @relation(fields: [callId], references: [id], onDelete: Cascade)
  customer        Customer       @relation("CustomerCallFeedback", fields: [customerId], references: [id], onDelete: Cascade)
  visit           CustomerVisit? @relation(fields: [visitId], references: [id], onDelete: Cascade)
  submittedByUser User           @relation(fields: [submittedBy], references: [id])

  @@index([customerId])
  @@index([visitId])
  @@map("call_feedback")
}

enum CallOutcome {
  SUCCESSFUL
  NO_ANSWER
  BUSY
  INVALID_NUMBER
  OTHER
}

enum CustomerMood {
  HAPPY
  NEUTRAL
  UNHAPPY
  ANGRY
  UNKNOWN
}

// Cross-Selling Attempt Tracking
model CrossSellingAttempt {
  id                   String      @id @default(auto()) @map("_id") @db.ObjectId
  visitId              String      @map("visit_id") @db.ObjectId
  customerId           String      @map("customer_id") @db.ObjectId
  salespersonId        String      @map("salesperson_id") @db.ObjectId
  salespersonName      String      @map("salesperson_name")
  customerDepartment   String      @map("customer_department")
  suggestedDepartments String[]    @map("suggested_departments")
  attemptDate          DateTime    @map("attempt_date")
  attemptType          AttemptType @map("attempt_type")
  createdAt            DateTime    @default(now()) @map("created_at")

  visit       CustomerVisit @relation(fields: [visitId], references: [id], onDelete: Cascade)
  customer    Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  salesperson User          @relation(fields: [salespersonId], references: [id])

  @@index([visitId])
  @@index([customerId])
  @@index([salespersonId])
  @@map("cross_selling_attempts")
}

enum AttemptType {
  VERBAL
  DISPLAY
  PAMPHLET
  OTHER
}

// Follow-up Reminders
model FollowUpReminder {
  id           String         @id @default(auto()) @map("_id") @db.ObjectId
  customerId   String         @map("customer_id") @db.ObjectId
  callId       String?        @map("call_id") @db.ObjectId
  createdBy    String         @map("created_by") @db.ObjectId
  assignedTo   String         @map("assigned_to") @db.ObjectId
  reminderDate DateTime       @map("reminder_date")
  status       ReminderStatus @default(PENDING)
  notes        String?
  createdAt    DateTime       @default(now()) @map("created_at")
  completedAt  DateTime?      @map("completed_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  creator  User     @relation("ReminderCreator", fields: [createdBy], references: [id])
  assignee User     @relation("ReminderAssignee", fields: [assignedTo], references: [id])

  @@index([customerId])
  @@index([assignedTo])
  @@index([status])
  @@index([reminderDate])
  @@map("follow_up_reminders")
}

enum ReminderStatus {
  PENDING
  COMPLETED
  DISMISSED
}

// Call Audit Logs
model CallAuditLog {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  callId      String   @map("call_id") @db.ObjectId
  action      String
  performedBy String   @map("performed_by")
  details     Json? // Additional context
  timestamp   DateTime @default(now())

  call Call @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@index([callId])
  @@map("call_audit_logs")
}

// Customer Interaction Analytics (Pre-computed for performance)
model CustomerAnalytics {
  id                    String    @id @default(auto()) @map("_id") @db.ObjectId
  customerId            String    @unique @map("customer_id") @db.ObjectId
  totalVisits           Int       @default(0) @map("total_visits")
  totalCalls            Int       @default(0) @map("total_calls")
  totalFeedback         Int       @default(0) @map("total_feedback")
  averageRating         Float?    @map("average_rating")
  lastCallDate          DateTime? @map("last_call_date")
  lastVisitDate         DateTime? @map("last_visit_date")
  preferredDepartments  String[]  @map("preferred_departments")
  preferredSalespersons String[]  @map("preferred_salespersons")
  repeatCustomer        Boolean   @default(false) @map("repeat_customer")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_analytics")
}
